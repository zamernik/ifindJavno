@{
    ViewData["Title"] = "Domov";
    Layout = "~/Views/Shared/_Layout.cshtml";   //osnoven layot(head/footer)
}

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<!-- Zemljevid zavzame ves ostal prostor med headerjem in footerjem, prej je izgledalo grdo -->
<div id="map"></div>

@section Styles {
    <style>
        html, body { height: 100%; margin: 0; }
        #map { height: 100vh; width: 100%; position: fixed; top: 0; left: 0; z-index: 1; }
        header { position: relative; z-index: 10; }
        footer { position: relative; z-index: 10; }
    </style>
}

@section Scripts {
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script> <!-- link js za leaflet -->

    <script>
        // Globalni token – enkrat preberemo iz layouta in ga uporabljamo povsod
        const antiforgeryToken = document.querySelector('input[name="__RequestVerificationToken"]')?.value || '';

        let currentDogodekId = 0;

        async function togglePridem() {
            if (!@User.Identity.IsAuthenticated.ToString().ToLower()) {
                alert("Za prijavo na dogodek se moraš prijaviti v aplikacijo!");
                return;
            }

            try {
                const response = await fetch('/Home/ToggleUdelezba', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': antiforgeryToken
                    },
                    body: JSON.stringify({ dogodekId: currentDogodekId })
                });

                if (!response.ok) {
                    console.error("Napaka na strežniku:", response.status);
                    return;
                }

                const data = await response.json();
                console.log("Odgovor od serverja:", data);  // ← DODAJ TO!

                if (data.uspesno) {
                    const btn = document.getElementById('pridemBtn');
                    if (data.prijavljen) {
                        btn.textContent = "Ne pridem";
                        btn.style.background = "#dc3545";
                    } else {
                        btn.textContent = "Pridem!";
                        btn.style.background = "#007bff";
                    }
                } else {
                    alert("Napaka: " + (data.sporocilo || "Neznana napaka"));  // ← DODAJ TO ZA ALERT
                }
            } catch (err) {
                console.error("Napaka pri klicu:", err);
            }
        }
        async function nastaviGumb(dogodekId) {
            console.log('Prejeti dogodekId v nastaviGumb:', dogodekId);  // ZAČASNO, da vidimo, če je undefined ali 0
            currentDogodekId = dogodekId;
            const btn = document.getElementById('pridemBtn');

            if (!@User.Identity.IsAuthenticated.ToString().ToLower()) {
                btn.textContent = "Pridem!";
                btn.style.background = "#007bff";
                return;
            }

            try {
                const res = await fetch(`/Home/GetUdelezbaStatus?dogodekId=${dogodekId}`);
                const data = await res.json();
                if (data.prijavljen) {
                    btn.textContent = "Ne pridem";
                    btn.style.background = "#dc3545";
                } else {
                    btn.textContent = "Pridem!";
                    btn.style.background = "#007bff";
                }
            } catch (err) {
                console.error("Napaka pri preverjanju statusa:", err);
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            const map = L.map('map').setView([46.0569, 14.5058], 8); //nastavim na Slovenijo

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);

            fetch('/Home/GetEvents')
                .then(r => r.json())
                .then(data => {
                    console.log('Vsi dogodki iz GetEvents:', data);  // ZAČASNO (ali ima vsak "id": številka >0)
                    data.forEach(e => {
                        const popupHtml = `
                            <div style="font-family: Arial, sans-serif; min-width: 220px;">
                                <h5 style="margin:0 0 6px 0; font-size:16px; color:#1a1a1a;">
                                    ${e.Naziv || e.naziv}
                                </h5>
                                <div style="margin-bottom:4px; color:#0066cc; font-weight:bold;">
                                    (${e.Kategorija || e.kategorija})
                                </div>
                                <div style="margin-bottom:8px; color:#444; font-size:14px;">
                                    ${e.DatumCas || e.datumCas}
                                </div>
                                <div style="font-size:14px; line-height:1.4; color:#333;">
                                    ${e.opis || e.Opis}
                                </div>
                                <div style="margin-top:12px; text-align:right;">
                                    <button id="pridemBtn" onclick="togglePridem()" 
                                            style="color:white; border:none; padding:8px 16px; border-radius:4px; cursor:pointer; background:#007bff;">
                                        Pridem!
                                    </button>
                                </div>
                            </div>
                        `;

                        L.marker([e.lat, e.lng])
                            .addTo(map)
                            .bindPopup(popupHtml, { 
                                maxWidth: 300,
                                autoPanPaddingTopLeft: [50, 100],
                                autoPanPaddingBottomRight: [50, 50]
                            })
                            .on('popupopen', () => nastaviGumb(e.id));
                    });
                })
                .catch(err => console.error('Napaka pri pridobivanju dogodkov:', err));
        });
    </script>
}